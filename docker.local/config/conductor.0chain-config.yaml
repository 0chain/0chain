---
enable:
  - "0chain_config_tests"

# sets of test cases
sets:
  - name: "0chain_config_tests"
    tests:
      # - "test min_generators"
      - "test min_active_sharders"
      # - "test max_block_cost"
      # - "test max_byte_size"
      # - "test payload max_size"

#
# test cases
#
tests:
  - name: "test min_generators"
    flow:
      - magic_block_config: config/b0magicBlock_4_miners_2_sharders.json
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - update_config:
          - file_name: "0chain-yaml"
            changes:
              - key: "server_chain.block.min_generators"
                value: 3
      - wait_add:
          sharders: ['sharder-1', 'sharder-2']
          miners: ['miner-1', 'miner-2', 'miner-3', 'miner-4']
          start: true
      - wait_round:
          shift: 10
          timeout: "5m"
      - stop: ['miner-3','miner-4']
      - wait_no_progress:
          timeout: "1m"
  
  - name: "test min_active_sharders"
    flow:
      - magic_block_config: config/b0magicBlock_4_miners_2_sharders.json
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - update_config:
          - file_name: "0chain-yaml"
            changes:
              - key: "server_chain.block.sharding.min_active_sharders"
                value: 80
      - wait_add:
          sharders: ['sharder-1', 'sharder-2']
          miners: ['miner-1', 'miner-2', 'miner-3', 'miner-4']
          start: true
      - wait_round:
          shift: 10
          timeout: "5m"
      - stop: ['sharder-2']
      - sleep: "30s"
      - wait_no_progress:
          timeout: "1m"

  - name: "test max_block_cost"
    flow:
      - magic_block_config: config/b0magicBlock_4_miners_2_sharders.json
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - update_config:
          - file_name: "0chain-yaml"
            changes:
              - key: "server_chain.block.max_block_cost"
                value: 10
      - wait_add:
          sharders: ['sharder-1', 'sharder-2']
          miners: ['miner-1', 'miner-2', 'miner-3', 'miner-4']
          start: true
      - wait_no_progress:
          timeout: "1m"

  - name: "test max_byte_size"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - command:
          name: "cleanup_0dns"
      - update_config:
          - file_name: "0chain-yaml"
            changes:
              - key: "server_chain.block.max_byte_size"
                value: 10000
      - wait_add:
          sharders: ['sharder-1']
          miners: ['miner-1', 'miner-2', 'miner-3']
          start: true
      - start: ['0dns']
      - wait_round:
          shift: 100
          timeout: "5m"
      - command:
          name: send_transaction_with_large_payload
    
  - name: "test payload max_size"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - command:
          name: "cleanup_0dns"
      - update_config:
          - file_name: "0chain-yaml"
            changes:
              - key: "server_chain.transaction.payload.max_size"
                value: 10000
      - wait_add:
          sharders: ['sharder-1']
          miners: ['miner-1', 'miner-2', 'miner-3']
          start: true
      - start: ['0dns']
      - wait_round:
          shift: 100
          timeout: "5m"
      - command:
          name: send_transaction_with_large_payload
