###
### View Change Fault Tolerance Tests
### Phases:
###  - 'start'
###  - 'contribute'
###  - 'share'
###  - 'publish'
###  - 'wait'
### Default MagicBlock:
###   sharders: ["sharder-1"]
###   miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
###   k_percent: 0.75 of registered
###   t_percent: 0.51 of active
###   x_percent: 0.70 of min(max_n, num_dkg_miners)
###   min_s: 1, max_s: 2
###   min_n: 3, max_n: 7
###
### Outside Miners: ["miner-5", "miner-5", "miner-7", "miner-8"]
### Outside Sharders: ["sharder-3"]
###
### Phase Rounds:
###   start_rounds: 50
###   contribute_rounds: 50
###   share_rounds: 50
###   publish_rounds: 50
###   wait_rounds: 50
###

---
enable:
  # View Change
  # - "Miner goes down"
  # - "Miner goes down and comes up"
  # - "Outside miner comes up"
  # - "Outside miner comes up and goes down"
  # - "Sharder goes down"
  # - "Sharder goes down and comes up"
  # - "Outside sharder comes up"
  # - "Outside sharder comes up and goes down"

  # Threshold Conditions
  # - "Threshold min/max miners"
  # - "Threshold min/max sharders"
  # - "Threshold K miners"
  - "More nodes than current active set come online at once"
  - "X percent of miners are from previous MB"

  # # Fault Tolerance - Stress Test
  # - "All miners go down and come up"
  # - "All sharders go down and come up"
  # - "All nodes go down and come up"
  # - "All nodes fail and recover randomly"

sets:
  # View Change
  - name: "Miner goes down"
    tests:
      - "Miner goes down in phase 'start'"
      - "Miner goes down in phase 'contribute'"
      - "Miner goes down in phase 'share'"
      - "Miner goes down in phase 'publish'"
      - "Miner goes down in phase 'wait'"

  - name: "Miner goes down and comes up"
    tests:
      - "Miner goes down in phase 'start' and comes up in phase 'start'"
      - "Miner goes down in phase 'start' and comes up in phase 'contribute'"
      - "Miner goes down in phase 'start' and comes up in phase 'share'"
      - "Miner goes down in phase 'start' and comes up in phase 'publish'"
      - "Miner goes down in phase 'start' and comes up in phase 'wait'"
      - "Miner goes down in phase 'contribute' and comes up in phase 'contribute'"
      - "Miner goes down in phase 'contribute' and comes up in phase 'share'"
      - "Miner goes down in phase 'contribute' and comes up in phase 'publish'"
      - "Miner goes down in phase 'contribute' and comes up in phase 'wait'"
      - "Miner goes down in phase 'share' and comes up in phase 'share'"
      - "Miner goes down in phase 'share' and comes up in phase 'publish'"
      - "Miner goes down in phase 'share' and comes up in phase 'wait'"
      - "Miner goes down in phase 'publish' and comes up in phase 'publish'"
      - "Miner goes down in phase 'publish' and comes up in phase 'wait'"
      - "Miner goes down in phase 'wait' and comes up in phase 'wait'"
      - "Miner goes down and comes up at VC - 1"
      - "Miner goes down and comes up at VC"
      - "Miner goes down and comes up at VC + 1"

  - name: "Outside miner comes up"
    tests:
      - "Outside miner comes up in phase 'start'"
      - "Outside miner comes up in phase 'contribute'"
      - "Outside miner comes up in phase 'share'"
      - "Outside miner comes up in phase 'publish'"
      - "Outside miner comes up in phase 'wait'"

  - name: "Outside miner comes up and goes down"
    tests:
      - "Outside miner comes up in phase 'start' and goes down in phase 'start'"
      - "Outside miner comes up in phase 'start' and goes down in phase 'contribute'"
      - "Outside miner comes up in phase 'start' and goes down in phase 'share'"
      - "Outside miner comes up in phase 'start' and goes down in phase 'publish'"
      - "Outside miner comes up in phase 'start' and goes down in phase 'wait'"
      - "Outside miner comes up in phase 'contribute' and goes down in phase 'contribute'"
      - "Outside miner comes up in phase 'contribute' and goes down in phase 'share'"
      - "Outside miner comes up in phase 'contribute' and goes down in phase 'publish'"
      - "Outside miner comes up in phase 'contribute' and goes down in phase 'wait'"
      - "Outside miner comes up in phase 'share' and goes down in phase 'share'"
      - "Outside miner comes up in phase 'share' and goes down in phase 'publish'"
      - "Outside miner comes up in phase 'share' and goes down in phase 'wait'"
      - "Outside miner comes up in phase 'publish' and goes down in phase 'publish'"
      - "Outside miner comes up in phase 'publish' and goes down in phase 'wait'"
      - "Outside miner comes up in phase 'wait' and goes down in phase 'wait'"

  - name: "Sharder goes down"
    tests:
      - "Sharder goes down in phase 'start'"
      - "Sharder goes down in phase 'contribute'"
      - "Sharder goes down in phase 'share'"
      - "Sharder goes down in phase 'publish'"
      - "Sharder goes down in phase 'wait'"

  - name: "Sharder goes down and comes up"
    tests:
      - "Sharder goes down in phase 'start' and comes up in phase 'start'"
      - "Sharder goes down in phase 'start' and comes up in phase 'contribute'"
      - "Sharder goes down in phase 'start' and comes up in phase 'share'"
      - "Sharder goes down in phase 'start' and comes up in phase 'publish'"
      - "Sharder goes down in phase 'start' and comes up in phase 'wait'"
      - "Sharder goes down in phase 'contribute' and comes up in phase 'contribute'"
      - "Sharder goes down in phase 'contribute' and comes up in phase 'share'"
      - "Sharder goes down in phase 'contribute' and comes up in phase 'publish'"
      - "Sharder goes down in phase 'contribute' and comes up in phase 'wait'"
      - "Sharder goes down in phase 'share' and comes up in phase 'share'"
      - "Sharder goes down in phase 'share' and comes up in phase 'publish'"
      - "Sharder goes down in phase 'share' and comes up in phase 'wait'"
      - "Sharder goes down in phase 'publish' and comes up in phase 'publish'"
      - "Sharder goes down in phase 'publish' and comes up in phase 'wait'"
      - "Sharder goes down in phase 'wait' and comes up in phase 'wait'"
      - "Sharder goes down and comes up at VC - 1"
      - "Sharder goes down and comes up at VC"
      - "Sharder goes down and comes up at VC + 1"

  - name: "Outside sharder comes up"
    tests:
      - "Outside sharder comes up in phase 'start'"
      - "Outside sharder comes up in phase 'contribute'"
      - "Outside sharder comes up in phase 'share'"
      - "Outside sharder comes up in phase 'publish'"
      - "Outside sharder comes up in phase 'wait'"

  - name: "Outside sharder comes up and goes down"
    tests:
      - "Outside sharder comes up in phase 'start' and goes down in phase 'start'"
      - "Outside sharder comes up in phase 'start' and goes down in phase 'contribute'"
      - "Outside sharder comes up in phase 'start' and goes down in phase 'share'"
      - "Outside sharder comes up in phase 'start' and goes down in phase 'publish'"
      - "Outside sharder comes up in phase 'start' and goes down in phase 'wait'"
      - "Outside sharder comes up in phase 'contribute' and goes down in phase 'contribute'"
      - "Outside sharder comes up in phase 'contribute' and goes down in phase 'share'"
      - "Outside sharder comes up in phase 'contribute' and goes down in phase 'publish'"
      - "Outside sharder comes up in phase 'contribute' and goes down in phase 'wait'"
      - "Outside sharder comes up in phase 'share' and goes down in phase 'share'"
      - "Outside sharder comes up in phase 'share' and goes down in phase 'publish'"
      - "Outside sharder comes up in phase 'share' and goes down in phase 'wait'"
      - "Outside sharder comes up in phase 'publish' and goes down in phase 'publish'"
      - "Outside sharder comes up in phase 'publish' and goes down in phase 'wait'"
      - "Outside sharder comes up in phase 'wait' and goes down in phase 'wait'"

  # Threshold
  - name: "Threshold min/max miners"
    tests:
      - "Miners count < min_n"
      - "Miners count >= min_n"
      - "Miners count <= max_n"
      - "Miners count > max_n"

  - name: "Threshold min/max sharders"
    tests:
      - "Sharders count < min_s"
      - "Sharders count >= min_s"
      - "Sharders count <= max_s"
      - "Sharders count > max_s"

  - name: "Threshold K miners"
    tests:
      - "Miners count < K (N=4, K=3)"
      - "Miners count >= K (N=4, K=3)"

  - name: "More nodes than current active set come online at once"
    tests:
      - "More nodes than current active set come online at once"
      # - "More nodes (with higher stakes) than current active set come online at once"

  - name: "X percent of nodes are from previous MB"
    tests:
      - "X percent of nodes are from previous MB"

  # Fault Tolerance - Stress Tests
  - name: "All miners go down and come up"
    tests:
      - "All miners go down and come up in phase 'start'"
      - "All miners go down and come up in phase 'contribute'"
      - "All miners go down and come up in phase 'share'"
      - "All miners go down and come up in phase 'publish'"
      - "All miners go down and come up in phase 'wait'"
      - "All miners go down and come up at VC - 1"
      - "All miners go down and come up at VC"
      - "All miners go down and come up at VC + 1"

  - name: "All sharders go down and come up"
    tests:
      - "All sharders go down and come up in phase 'start'"
      - "All sharders go down and come up in phase 'contribute'"
      - "All sharders go down and come up in phase 'share'"
      - "All sharders go down and come up in phase 'publish'"
      - "All sharders go down and come up in phase 'wait'"
      - "All sharders go down and come up at VC - 1"
      - "All sharders go down and come up at VC"
      - "All sharders go down and come up at VC + 1"

  - name: "All nodes go down and come up"
    tests:
      - "All nodes go down and come up in phase 'start'"
      - "All nodes go down and come up in phase 'contribute'"
      - "All nodes go down and come up in phase 'share'"
      - "All nodes go down and come up in phase 'publish'"
      - "All nodes go down and come up in phase 'wait'"
      - "All nodes go down and come up at VC - 1"
      - "All nodes go down and come up at VC"
      - "All nodes go down and come up at VC + 1"

  - name: "All nodes fail and recover randomly"
    tests:
      - "All nodes fail and recover randomly"

tests:
  # - Miner goes down
  - name: "Miner goes down in phase 'start'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - stop: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - stop: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "share"
      - stop: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "publish"
      - stop: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "wait"
      - stop:
          - "miner-4"
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 3
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  # Miner goes down and comes up
  - name: "Miner goes down in phase 'start' and comes up in phase 'start'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - stop: ["miner-4"]
      - wait_round:
          shift: 15
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]

  - name: "Miner goes down in phase 'start' and comes up in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - stop: ["miner-4"]
      - wait_phase:
          phase: "contribute"
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'start' and comes up in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - stop: ["miner-4"]
      - wait_phase:
          phase: "share"
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'start' and comes up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - stop: ["miner-4"]
      - wait_phase:
          phase: "publish"
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'start' and comes up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - stop: ["miner-4"]
      - wait_phase:
          phase: "wait"
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'contribute' and comes up in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - stop: ["miner-4"]
      - wait_round:
          shift: 15
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'contribute' and comes up in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - stop: ["miner-4"]
      - wait_phase:
          phase: "share"
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'contribute' and comes up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - stop: ["miner-4"]
      - wait_phase:
          phase: "publish"
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'contribute' and comes up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - stop: ["miner-4"]
      - wait_phase:
          phase: "wait"
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'share' and comes up in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "share"
      - stop: ["miner-4"]
      - wait_round:
          shift: 15
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'share' and comes up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "share"
      - stop: ["miner-4"]
      - wait_phase:
          phase: "publish"
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'share' and comes up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "share"
      - stop: ["miner-4"]
      - wait_phase:
          phase: "wait"
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'publish' and comes up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "publish"
      - stop: ["miner-4"]
      - wait_round:
          shift: 15
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'publish' and comes up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "publish"
      - stop: ["miner-4"]
      - wait_phase:
          phase: "wait"
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miner goes down in phase 'wait' and comes up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "wait"
      - stop: ["miner-4"]
      - wait_round:
          shift: 15
      - start: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]

  - name: "Miner goes down and comes up at VC - 1"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_phase:
          phase: "wait"
      - wait_round:
          shift: 48
      - stop: ["miner-1"]
      - start: ["miner-1"]
      - wait_view_change:
          timeout: "10m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1"]
      - wait_round:
          shift: 10 # make sure it moves on after the VC

  - name: "Miner goes down and comes up at VC"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_phase:
          phase: "wait"
      - wait_round:
          shift: 49
      - stop: ["miner-1"]
      - start: ["miner-1"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1"]
      - wait_round:
          shift: 10 # make sure it moves on after the VC

  - name: "Miner goes down and comes up at VC + 1"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1"]
      - wait_round:
          shift: 1
      - stop: ["miner-1"]
      - start: ["miner-1"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1"]

  # Outside miner comes up
  #   doesn't matter what phase, an outside miner only starts from phase 0)
  #   outside miner: miner-5
  - name: "Outside miner comes up in phase 'start'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3", "miner-5"]

  - name: "Outside miner comes up in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 3
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3", "miner-5"]

  - name: "Outside miner comes up in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "share"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 3
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3", "miner-5"]

  - name: "Outside miner comes up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "publish"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 3
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3", "miner-5"]

  - name: "Outside miner comes up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "wait"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 3
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3", "miner-5"]

  # Outside miner comes up and goes down
  - name: "Outside miner comes up in phase 'start' and goes down in phase 'start'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_round:
          shift: 15
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'start' and goes down in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_phase:
          phase: "contribute"
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'start' and goes down in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_phase:
          phase: "share"
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'start' and goes down in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_phase:
          phase: "publish"
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'start' and goes down in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_phase:
          phase: "wait"
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3", "miner-5"]

  - name: "Outside miner comes up in phase 'contribute' and goes down in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_round:
          shift: 15
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'contribute' and goes down in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_phase:
          phase: "share"
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'contribute' and goes down in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_phase:
          phase: "publish"
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'contribute' and goes down in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_phase:
          phase: "wait"
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'share' and goes down in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "share"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_round:
          shift: 15
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'share' and goes down in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "share"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_phase:
          phase: "publish"
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'share' and goes down in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "share"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_phase:
          phase: "wait"
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'publish' and goes down in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "publish"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_round:
          shift: 15
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'publish' and goes down in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "publish"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_phase:
          phase: "wait"
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside miner comes up in phase 'wait' and goes down in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["miner-5"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "wait"
      - unlock: ["miner-5"]
      - wait_add:
          miners: ["miner-5"]
      - wait_round:
          shift: 15
      - stop: ["miner-5"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  # Sharder goes down (2 sharders, 3 miners)
  #   as default magic block has 1s-4m, we'll first wait
  #   for a view-change to have 2s-4m configuration
  - name: "Sharder goes down in phase 'start'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "start"
      - stop: ["sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "contribute"
      - stop: ["sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "share"
      - stop: ["sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            # sharders: ["sharder-1"] # FAIL
            sharders: ["sharder-1", "sharder-2"] # Need to ensure if this is correct
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "publish"
      - stop: ["sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            # sharders: ["sharder-1"] # FAIL
            sharders: ["sharder-1", "sharder-2"] # Need to ensure if this is correct
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "wait"
      - stop: ["sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-2"]
            miners: ["miner-1", "miner-2", "miner-3"]

  # Sharder goes down and comes up
  - name: "Sharder goes down in phase 'start' and comes up in phase 'start'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "start"
      - stop: ["sharder-2"]
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-2"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'start' and comes up in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "start"
      - stop: ["sharder-2"]
      - wait_phase:
          phase: "contribute"
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'start' and comes up in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "start"
      - stop: ["sharder-2"]
      - wait_phase:
          phase: "share"
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'start' and comes up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "start"
      - stop: ["sharder-2"]
      - wait_phase:
          phase: "publish"
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'start' and comes up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "start"
      - stop: ["sharder-2"]
      - wait_phase:
          phase: "wait"
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'contribute' and comes up in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "contribute"
      - stop: ["sharder-2"]
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-2"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'contribute' and comes up in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "contribute"
      - stop: ["sharder-2"]
      - wait_phase:
          phase: "share"
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'contribute' and comes up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "contribute"
      - stop: ["sharder-2"]
      - wait_phase:
          phase: "publish"
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'contribute' and comes up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "contribute"
      - stop: ["sharder-2"]
      - wait_phase:
          phase: "wait"
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'share' and comes up in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "share"
      - stop: ["sharder-2"]
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-2"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'share' and comes up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "share"
      - stop: ["sharder-2"]
      - wait_phase:
          phase: "publish"
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'share' and comes up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "share"
      - stop: ["sharder-2"]
      - wait_phase:
          phase: "wait"
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'publish' and comes up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "publish"
      - stop: ["sharder-2"]
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-2"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'publish' and comes up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "publish"
      - stop: ["sharder-2"]
      - wait_phase:
          phase: "wait"
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down in phase 'wait' and comes up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "wait"
      - stop: ["sharder-2"]
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-2"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharder goes down and comes up at VC - 1"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "wait"
      - wait_round:
          shift: 48
      - stop: ["sharder-2"]
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-2"]
            miners: ["miner-1", "miner-2", "miner-3"]
      - wait_round:
          shift: 10 # make sure it moves on after the VC

  - name: "Sharder goes down and comes up at VC"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_phase:
          phase: "wait"
      - wait_round:
          shift: 49
      - stop: ["sharder-2"]
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-2"]
            miners: ["miner-1", "miner-2", "miner-3"]
      - wait_round:
          shift: 10 # make sure it moves on after the VC

  - name: "Sharder goes down and comes up at VC + 1"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_round:
          shift: 1
      - stop: ["sharder-2"]
      - start: ["sharder-2"] # TODO: ensure it starts within start phase
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-2"]
            miners: ["miner-1", "miner-2", "miner-3"]

  # Outside sharder comes up
  - name: "Outside sharder comes up in phase 'start'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-3"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-3"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "share"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "publish"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "wait"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  # Outside sharder comes up and goes down
  - name: "Outside sharder comes up in phase 'start' and goes down in phase 'start'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_round:
          shift: 15
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'start' and goes down in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_phase:
          phase: "contribute"
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'start' and goes down in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_phase:
          phase: "share"
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            # sharders: ["sharder-1"] # FAIL
            sharders: ["sharder-1", "sharder-3"] # Need to ensure if this is correct
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'start' and goes down in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_phase:
          phase: "publish"
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            # sharders: ["sharder-1"] # FAIL
            sharders: ["sharder-1", "sharder-3"] # Need to ensure if this is correct
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'start' and goes down in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_phase:
          phase: "wait"
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-3"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'contribute' and goes down in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_round:
          shift: 15
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            # sharders: ["sharder-1"] # FAIL
            sharders: ["sharder-1", "sharder-3"] # Need to ensure if this is correct
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'contribute' and goes down in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_phase:
          phase: "share"
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            # sharders: ["sharder-1"] # FAIL
            sharders: ["sharder-1", "sharder-3"] # Need to ensure if this is correct
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'contribute' and goes down in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_phase:
          phase: "publish"
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            # sharders: ["sharder-1"] # FAIL
            sharders: ["sharder-1", "sharder-3"] # Need to ensure if this is correct
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'contribute' and goes down in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_phase:
          phase: "wait"
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-3"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'share' and goes down in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "share"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_round:
          shift: 15
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'share' and goes down in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "share"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_phase:
          phase: "publish"
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'share' and goes down in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "share"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_phase:
          phase: "wait"
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'publish' and goes down in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "publish"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_round:
          shift: 15
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'publish' and goes down in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "publish"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_phase:
          phase: "wait"
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Outside sharder comes up in phase 'wait' and goes down in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start_lock: ["sharder-3"]
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "wait"
      - unlock: ["sharder-3"]
      - wait_add:
          sharders: ["sharder-3"]
      - wait_round:
          shift: 15
      - stop: ["sharder-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  # Threshold min/max miners
  - name: "Miners count < min_n"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - stop: ["miner-3", "miner-4"]
      - wait_no_view_change:
          round: 650

  - name: "Miners count >= min_n"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - stop: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Miners count <= max_n"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start:
          [
            "miner-1",
            "miner-2",
            "miner-3",
            "miner-4",
            "miner-5",
            "miner-6",
            "miner-7",
          ]
      - wait_add:
          sharders: ["sharder-1"]
          miners:
            [
              "miner-1",
              "miner-2",
              "miner-3",
              "miner-4",
              "miner-5",
              "miner-6",
              "miner-7",
            ]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners:
              [
                "miner-1",
                "miner-2",
                "miner-3",
                "miner-4",
                "miner-5",
                "miner-6",
                "miner-7",
              ]

  - name: "Miners count > max_n"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start:
          [
            "miner-1",
            "miner-2",
            "miner-3",
            "miner-4",
            "miner-5",
            "miner-6",
            "miner-7",
            "miner-8",
          ]
      - wait_add:
          sharders: ["sharder-1"]
          miners:
            [
              "miner-1",
              "miner-2",
              "miner-3",
              "miner-4",
              "miner-5",
              "miner-6",
              "miner-7",
              "miner-8",
            ]
      - stop: ["miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            # sharders: ["sharder-1"]
            # miners: [...] # any max_n of the miners are selected ordered by stake (high->low) and id (ascending)

  # Threshold min/max miners
  - name: "Sharders count < min_s"
    flow:
      - set_monitor: "miner-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - stop: ["sharder-1"]
      - wait_no_progress:
          timeout: "5m"

  - name: "Sharders count >= min_s"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharders count <= max_s"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1", "sharder-2"]
            miners: ["miner-1", "miner-2", "miner-3"]

  - name: "Sharders count > max_s"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2", "sharder-3"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            # sharders: [...] # any max_s of the sharders are selected ordered by stake (high->low) and id (ascending)
            # miners: ["miner-1", "miner-2", "miner-3"]

  # Threshold K miners
  - name: "Miners count < K (N=4, K=3)"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - stop: ["miner-3", "miner-4"]
      - wait_no_progress:
          timeout: "5m"

  - name: "Miners count >= K (N=4, K=3)"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - stop: ["miner-4"]
      - wait_round:
          shift: 20

  - name: "More nodes than current active set come online at once"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]
      - start: ["sharder-2", "sharder-3"]
      - start: ["miner-4", "miner-5", "miner-6", "miner-7", "miner-8"]
      - wait_view_change:
          timeout: "5m"
      - wait_round:
          shift: 30

  - name: "X percent of nodes are from previous MB"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]
      - start: ["sharder-2", "sharder-3"]
      - start: ["miner-4", "miner-5", "miner-6", "miner-7", "miner-8"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 3
            # Even though new miners have higher stake than current mb miners
            # all of the current mb miners should be included in next mb
            # TODO: need to add ability to check presence subset of nodes

  # All miners go down and come up
  - name: "All miners go down and come up in phase 'start'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1"] # sync nodes
      - wait_phase:
          phase: "start"
      - stop: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3"]
            sharders: ["sharder-1"]

  - name: "All miners go down and come up in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_phase:
          phase: "contribute"
      - stop: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3"]
            sharders: ["sharder-1"]

  - name: "All miners go down and come up in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_phase:
          phase: "share"
      - stop: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "15m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3"]
            sharders: ["sharder-1"]

  - name: "All miners go down and come up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_phase:
          phase: "publish"
      - stop: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3"]
            sharders: ["sharder-1"]

  - name: "All miners go down and come up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_phase:
          phase: "wait"
      - stop: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3"]
            sharders: ["sharder-1"]

  - name: "All miners go down and come up at VC - 1"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_phase:
          phase: "wait"
      - wait_round:
          shift: 48
      - stop: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1"]

  - name: "All miners go down and come up at VC"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_phase:
          phase: "wait"
      - wait_round:
          shift: 49
      - stop: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1"]

  - name: "All miners go down and come up at VC + 1"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1"]
      - wait_round:
          shift: 1
      - stop: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1"]

  # All sharders go down and come up (2 sharders, 3 miners)
  - name: "All sharders go down and come up in phase 'start'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "start"
      - stop: ["sharder-1", "sharder-2"]
      - start: ["sharder-1", "sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All sharders go down and come up in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - stop: ["sharder-1", "sharder-2"]
      - start: ["sharder-1", "sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All sharders go down and come up in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "share"
      - stop: ["sharder-1", "sharder-2"]
      - start: ["sharder-1", "sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All sharders go down and come up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "publish"
      - stop: ["sharder-1", "sharder-2"]
      - start: ["sharder-1", "sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All sharders go down and come up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "wait"
      - stop: ["sharder-1", "sharder-2"]
      - start: ["sharder-1", "sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All sharders go down and come up at VC - 1"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "wait"
      - wait_round:
          shift: 48
      - stop: ["sharder-1", "sharder-2"]
      - start: ["sharder-1", "sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All sharders go down and come up at VC"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "wait"
      - wait_round:
          shift: 49
      - stop: ["sharder-1", "sharder-2"]
      - start: ["sharder-1", "sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All sharders go down and come up at VC + 1"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]
      - wait_round:
          shift: 1
      - stop: ["sharder-1", "sharder-2"]
      - start: ["sharder-1", "sharder-2"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  # All nodes go down and come up at phase X
  - name: "All nodes go down and come up in phase 'contribute'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "contribute"
      - stop: ["sharder-1", "sharder-2", "miner-1", "miner-2", "miner-3"]
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All nodes go down and come up in phase 'share'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "share"
      - stop: ["sharder-1", "sharder-2", "miner-1", "miner-2", "miner-3"]
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All nodes go down and come up in phase 'publish'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "publish"
      - stop: ["sharder-1", "sharder-2", "miner-1", "miner-2", "miner-3"]
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All nodes go down and come up in phase 'wait'"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "wait"
      - stop: ["sharder-1", "sharder-2", "miner-1", "miner-2", "miner-3"]
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All nodes go down and come up at VC - 1"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "wait"
      - wait_round:
          shift: 48
      - stop: ["sharder-1", "sharder-2", "miner-1", "miner-2", "miner-3"]
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All nodes go down and come up at VC"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_add:
          sharders: ["sharder-1", "sharder-2"]
          miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_sharder_keep:
          sharders: ["sharder-1", "sharder-2"] # sync nodes
      - wait_phase:
          phase: "wait"
      - wait_round:
          shift: 49
      - stop: ["sharder-1", "sharder-2", "miner-1", "miner-2", "miner-3"]
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All nodes go down and come up at VC + 1"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]
      - wait_round:
          shift: 1
      - stop: ["sharder-1", "sharder-2", "miner-1", "miner-2", "miner-3"]
      - start: ["sharder-1", "sharder-2"]
      - start: ["miner-1", "miner-2", "miner-3", "miner-4"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            miners: ["miner-1", "miner-2", "miner-3", "miner-4"]
            sharders: ["sharder-1", "sharder-2"]

  - name: "All nodes fail and recover randomly"
    flow:
      - set_monitor: "sharder-1"
      - cleanup_bc: {}
      - start: ["sharder-1"]
      - start: ["miner-1", "miner-2", "miner-3"]
      - wait_add:
          sharders: ["sharder-1"]
          miners: ["miner-1", "miner-2", "miner-3"]
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 2
            sharders: ["sharder-1"]
            miners: ["miner-1", "miner-2", "miner-3"]
      - stop: ["miner-3"] # < min_n=3
      - wait_no_view_change:
          round: 650
      - start: ["miner-3"] # == min_n=3
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 3
            miners: ["miner-1", "miner-2", "miner-3"]
            sharders: ["sharder-1"]
      - stop: ["sharder-1"] # no sharder
      - set_monitor: "miner-1"
      - wait_no_progress:
          timeout: "5m"
      - set_monitor: "sharder-1"
      - start: ["sharder-1", "sharder-2"]
      - stop: ["miner-3"]
      - start: ["miner-5"] # external miner; == min_n
      - wait_view_change:
          timeout: "5m"
          expect_magic_block:
            number: 4
            miners: ["miner-1", "miner-2", "miner-5"]
            sharders: ["sharder-1", "sharder-2"]
      # To be continued
