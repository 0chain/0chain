
- name: "Create key={{key_pair}} in region={{primary_region}}"
  ec2_key:
    name: "{{key_pair}}"
    region: "{{primary_region}}"
  register: keypair
  tags:
    - key-create

- debug: msg="key={{key_pair}} contents={{keypair}}"
  tags:
    - key-create

- name: "Save key={{key_pair}} to file={{key_pair_file}}"
  copy:
    dest: "{{key_pair_file}}"
    content: "{{ keypair.key.private_key }}"
    mode: 0400
  when: keypair.changed
  tags:
    - key-create

- name: "Generate the public key"
  command: ssh-keygen -y -f "{{key_pair_file}}" -t rsa -q
  register: publickey
  tags:
    - key-create

- name: "Save public key {{publickey}} to  {{public_key_file}}"
  copy:
    dest: "{{public_key_file}}"
    content: "{{ publickey.stdout}}"
    mode: 0400
  tags:
    - key-create

- name: "Add key={{key_pair}} to regions={{region_tags}}"
  ec2_key:
    name: "{{key_pair}}"
    region: "{{ item.value }}"
    key_material: "{{publickey.stdout}}"
    state: present
  with_dict: "{{ regions }}"
  tags:
    - key-create


- name: "Remove key={{key_pair}} from regions={{region_tags}}"
  ec2_key:
    name: "{{key_pair}}"
    region: "{{ item.value}}"
    state: absent
  with_dict: "{{ regions }}"
  tags:
    - key-delete

- name: "Delete key={{key_pair}} file={{key_pair_file}}"
  file: path="{{key_pair_file}}" state=absent
  tags:
    - key-delete
