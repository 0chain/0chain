---
- name: "Nodefile storage"
  debug:
    msg: "Node files storage: {{nodefiles}}"

- name: "Update Route53 database"
  route53:
    state: present
    zone: testnet-0chain.net
    record: "{{item.tags.Name}}.{{blueprint.network_name}}.testnet-0chain.net"
    value: "{{item.public_ip_address}}"
    type: A
    wait: no
    overwrite: yes
    ttl: 60
  with_items: "{{nodes}}"
  loop_control:
    label: "{{item.tags.Name}} ==> {{item.public_ip_address}}"

- set_fact:
    nodes_workdir:
    - "{{nodefiles.dir.local}}"
    - "{{nodefiles.dir.local}}/agent_nodes"
    - "{{nodefiles.dir.local}}/agent_keys"

- name: Delete old contents
  file:
    state: absent
    path: "{{item}}"
  with_items: "{{nodes_workdir}}"

- name: Create node work directories...
  file:
    state: directory
    path: "{{item}}"
  with_items: "{{nodes_workdir}}"

#Create the agent files...
- name: "Create miner and sharder node attributes"
  template:
    src: "agent_attribute.j2"
    dest: "{{nodefiles.dir.local}}/agent_nodes/{{item.tags.Name}}.yml"
  with_items: "{{nodes}}"
  loop_control:
      label: "{{item.tags.Name}}"

#Set fact
- name: "Update miner and sharder section"
  set_fact:
    miner_section: "{{nodefiles.dir.local}}/agent_nodes/miners.yml"
    sharder_section:  "{{nodefiles.dir.local}}/agent_nodes/sharders.yml"

#Merge the miner files...
- name: "Merge the miner portion"
  assemble:
    src: "{{nodefiles.dir.local}}/agent_nodes"
    regexp: "m*.yml"
    dest: "{{miner_section}}"

- name: "Merge the sharder portion"
  assemble:
    src: "{{nodefiles.dir.local}}/agent_nodes"
    regexp: "s*.yml"
    dest: "{{sharder_section}}"

- name: "Copy template file"
  copy:
    src: "roles/agent-clientid/templates/agent_nodes.j2"
    dest: "{{nodefiles.dir.local}}/agent_nodes"

#Merge the agent files into one
- name: "Create the nodes yaml file"
  template:
    src: "{{nodefiles.dir.local}}/agent_nodes/agent_nodes.j2"
    dest: "{{nodefiles.dir.local}}/agent_nodes/{{nodefiles.file}}"

#- name: "Nodes file ==> {{nodefiles.dir.local}}/{{nodefiles.file}}"
#  lineinfile:
#    path: "{{nodefiles.dir.local}}/{{nodefiles.file}}"
#    create: yes
#    line: "{{item.tags.Name[0]}},{{item.public_ip_address}},{{zchain.blueprint.ports[item.tags.role]}},{{clientid[item.tags.Name].client}},{{clientid[item.tags.Name].public}}"
#  with_items: "{{nodes}}"
#  loop_control:
#    label: "{{item.tags.Name}} ==> {{item.public_ip_address}}"

- name: "Create the keyid file..."
  template:
    src: "agent_keyid.j2"
    dest: "{{nodefiles.dir.local}}/agent_keys/{{item.key}}.txt"
  with_items: "{{agents}}"
  loop_control:
    label: "{{item.key}}"

#- name: "Create the new node file...adding public key"
#  lineinfile:
#      path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
#      create: yes
#      line: "{{clientid[item.key].public}}"
#  with_items: "{{agents}}"
#
#- name: "Create the new node file...adding private key"
#  lineinfile:
#      path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
#      create: yes
#      line: "{{clientid[item.key].private}}"
#  with_items: "{{agents}}"
#
#- name: "Closing node file..."
#  lineinfile:
#      path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
#      create: yes
#      line: ""
#  with_items: "{{agents}}"
...