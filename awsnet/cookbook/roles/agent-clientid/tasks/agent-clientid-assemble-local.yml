---
- name: "Nodefile storage"
  debug:
    msg: "Node files storage: {{nodefiles}}"
    verbosity: 2

- name: Clean the old nodefile directory
  file:
    state: absent
    path: "{{nodefiles.dir.local}}"

- debug:
    msg: "Show iprole {{iprole}}"
    verbosity: 2

- name: "Nodes file ==> {{nodefiles.dir.local}}/{{nodefiles.file}}"
  lineinfile:
    path: "{{nodefiles.dir.local}}/{{nodefiles.file}}"
    create: yes
    line: "{{item.tags.Name[0]}},{{item.public_ip_address}},{{zchain.blueprint.ports[item.tags.role]}},{{clientid[item.tags.Name].client}},{{clientid[item.tags.Name].public}}"
  with_items: "{{nodes}}"
  loop_control:
    label: "{{item.tags.Name}} ==> {{item.public_ip_address}}"

- name: "Update Route53 database"
  route53:
    state: present
    zone: testnet-0chain.net
    record: "{{item.tags.Name}}.{{blueprint.network_name}}.testnet-0chain.net"
    value: "{{item.public_ip_address}}"
    type: A
    wait: no
    overwrite: yes
    ttl: 60
  with_items: "{{nodes}}"
  loop_control:
    label: "{{item.tags.Name}} ==> {{item.public_ip_address}}"


- name: "Creating the node mapping file..."
  debug:
    msg: "agent={{item}}"
    verbosity: 2
  with_items: "{{agents}}"

- name: "Delete old node key file..."
  file:
    path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
    state: absent
  with_items: "{{agents}}"

- name: "Create the new node file...adding public key"
  lineinfile:
      path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
      create: yes
      line: "{{clientid[item.key].public}}"
  with_items: "{{agents}}"

- name: "Create the new node file...adding private key"
  lineinfile:
      path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
      create: yes
      line: "{{clientid[item.key].private}}"
  with_items: "{{agents}}"

- name: "Closing node file..."
  lineinfile:
      path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
      create: yes
      line: ""
  with_items: "{{agents}}"

...