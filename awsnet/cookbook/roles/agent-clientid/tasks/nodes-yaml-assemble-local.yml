---
- name: "Nodefile storage"
  debug:
    msg: "Node files storage: {{nodefiles}}"

- name: Clean the old nodefile directory
  file:
    state: absent
    path: "{{nodefiles.dir.local}}"

- name: Clean the old nodefile directory
  file:
    state: directory
    path: "{{item}}"
  with_items:
    - "{{nodefiles.dir.local}}"
    - "{{nodefiles.dir.local}}/miner"
    - "{{nodefiles.dir.local}}/sharder"

#Create the agent files...
- name: "Create miner and sharder node attributes"
  template:
    src: "agent_attribute.j2"
    dest: "{{nodefiles.dir.local}}/{{item.tags.role}}/{{item.tags.Name}}.yml"
  with_items: "{{nodes}}"
  loop_control:
      label: "{{item.tags.Name}}"

#Set fact
- name: "Update miner and sharder section"
  set_fact:
    miner_section: "{{nodefiles.dir.local}}/miner/miners.yml"
    sharder_section:  "{{nodefiles.dir.local}}/sharder/sharders.yml"

#Merge the miner files...
- name: "Merge the miner portion"
  assemble:
    src: "{{nodefiles.dir.local}}/miner"
    regexp: "m*.yml"
    dest: "{{miner_section}}"

- name: "Merge the sharder portion"
  assemble:
    src: "{{nodefiles.dir.local}}/sharder"
    regexp: "s*.yml"
    dest: "{{sharder_section}}"

- name: "Copy template file"
  copy:
    src: "roles/agent-clientid/templates/agent_yaml.j2"
    dest: "{{nodefiles.dir.local}}"

#Merge the agent files into one
- name: "Create the nodes yaml file"
  template:
    src: "{{nodefiles.dir.local}}/agent_yaml.j2"
    dest: "{{nodefiles.dir.local}}/{{nodefiles.file}}"

#Assemble the files to create the
#Create sharder node files
#- name: "Create sharder node attributes"
#  template:
#    src: "agent_attribute.j2"
#    dest: "{{nodesfiles.dir.local}}"/sharders
#  with_items: "{{nodes}}"


#- name: "Nodes file ==> {{nodefiles.dir.local}}/{{nodefiles.file}}"
#  lineinfile:
#    path: "{{nodefiles.dir.local}}/{{nodefiles.file}}"
#    create: yes
#    line: "{{item.tags.Name[0]}},{{item.public_ip_address}},{{zchain.blueprint.ports[item.tags.role]}},{{clientid[item.tags.Name].client}},{{clientid[item.tags.Name].public}}"
#  with_items: "{{nodes}}"
#  loop_control:
#    label: "{{item.tags.Name}} ==> {{item.public_ip_address}}"

#- name: "Update Route53 database"
#  route53:
#    state: present
#    zone: testnet-0chain.net
#    record: "{{item.tags.Name}}.{{blueprint.network_name}}.testnet-0chain.net"
#    value: "{{item.public_ip_address}}"
#    type: A
#    wait: no
#    overwrite: yes
#    ttl: 60
#  with_items: "{{nodes}}"
#  loop_control:
#    label: "{{item.tags.Name}} ==> {{item.public_ip_address}}"


#- name: "Creating the node mapping file..."
#  debug:
#    msg: "agent={{item}}"
#    verbosity: 2
#  with_items: "{{agents}}"
#
#- name: "Delete old node key file..."
#  file:
#    path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
#    state: absent
#  with_items: "{{agents}}"
#
#- name: "Create the new node file...adding public key"
#  lineinfile:
#      path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
#      create: yes
#      line: "{{clientid[item.key].public}}"
#  with_items: "{{agents}}"
#
#- name: "Create the new node file...adding private key"
#  lineinfile:
#      path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
#      create: yes
#      line: "{{clientid[item.key].private}}"
#  with_items: "{{agents}}"
#
#- name: "Closing node file..."
#  lineinfile:
#      path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
#      create: yes
#      line: ""
#  with_items: "{{agents}}"

...