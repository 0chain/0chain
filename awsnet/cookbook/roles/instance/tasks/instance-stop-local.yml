---
- block:
  - set_fact:
      agent_role: "{{agent.value.role}}"

  - name: "Stop {{agent.key}}..."
    ec2:
      region: "{{regions[agent.value.region]}}"
      key_name: "{{aws_key_pair}}"
      wait: yes
      instance_tags: "{{instance_tags[agent.key]}}"
      state: stopped
      count: 1
    check_mode: no
    ignore_errors: yes

  - name: "Collect fact on stopped {{agent.key}}"
    ec2_instance_facts:
      region: "{{regions[agent.value.region]}}"
      filters:
        "tag:network_type": "{{zchain.blueprint.network_type}}"
        "tag:network_name": "{{zchain.blueprint.network_name}}"
        "tag:role": "{{agent_role}}"
        "tag:Name": "{{agent.key}}"
    register: ec2_facts

  - debug:
      msg: "{{ec2_facts}}"
      verbosity: 1

  - set_fact:
      nodes: "{{ec2_facts | json_query('instances')}}"

  - debug:
      msg: "state={{node.state}}"
    with_items: "{{nodes}}"
    loop_control:
      loop_var: node
      label: "{{agent.key}} => {{node.instance_id}}"
  tags: ['instance-stop-local']
...

