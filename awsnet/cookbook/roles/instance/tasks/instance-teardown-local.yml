- name: "Fire first request to terminate the servers..."
  ec2:
    region: "{{regions[item.value.region]}}"
    key_name: "{{aws_key_pair}}"
    instance_type: "{{zchain.blueprint.instance_type[item.value.role]}}"
    image: "{{instance_images[item.value.region]['ami_id']}}"
    wait: no
    termination_protection: no
    group:
    instance_tags:
      Name: "{{item.key}}"
      role: "{{item.value.role}}"
      network_type: "{{zchain.blueprint.network_type}}"
      network_name: "{{zchain.blueprint.network_name}}"
    exact_count: 0
    count_tag:
      Name: "{{item.key}}"
      role: "{{item.value.role}}"
      network_type: "{{zchain.blueprint.network_type}}"
      network_name: "{{zchain.blueprint.network_name}}"

  with_items: "{{agents}}"
  check_mode: no
  ignore_errors: yes
- name: "Wait for the servers to terminate..."
  ec2:
    region: "{{regions[item.value.region]}}"
    key_name: "{{aws_key_pair}}"
    instance_type: "{{zchain.blueprint.instance_type[item.value.role]}}"
    image: "{{instance_images[item.value.region]['ami_id']}}"
    wait: yes
    termination_protection: no
    group:
    instance_tags:
      Name: "{{item.key}}"
      role: "{{item.value.role}}"
      network_name: "{{zchain.blueprint.network_name}}"
      network_type: "{{zchain.blueprint.network_type}}"
    exact_count: 0
    count_tag:
      Name: "{{item.key}}"
      role: "{{item.value.role}}"
      network_type: "{{zchain.blueprint.network_type}}"
      network_name: "{{zchain.blueprint.network_name}}"

  with_items: "{{agents}}"
  check_mode: no
  ignore_errors: yes