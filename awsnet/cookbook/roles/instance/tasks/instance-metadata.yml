---
- block:
  - debug:
      msg: "aws={{aws_vars}}"
      verbosity: 2

  - name: Gather EC2 instance metadata
    ec2_metadata_facts:

  - debug:
      msg: "{{ansible_ec2_instance_id}}"
      verbosity: 2

  - debug:
      msg: "{{ansible_ec2_placement_region}}"
      verbosity: 2

  - name: Obtain EC2 tags for this instance
    local_action:
      module: ec2_tag
      aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
      aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY')}}"
      security_token: "{{ lookup('env', 'AWS_SECURITY_TOKEN')}}"
      region: "{{ ansible_ec2_placement_region }}"
      resource: "{{ ansible_ec2_instance_id }}"
      state: list
    register: ec2_tags

  - debug:
      msg: "{{ec2_tags}}"
      verbosity: 2

  - set_fact:
      agent_tags: "{{ec2_tags.tags}}"
      agent_role: "{{ec2_tags.tags.role}}"
      agent_name: "{{ec2_tags.tags.Name}}"
  tags: ['always']
...