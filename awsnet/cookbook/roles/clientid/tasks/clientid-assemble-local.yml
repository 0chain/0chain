---
#- name: "Ensure the nodes are in started state..."
#  ec2:
#    region: "{{regions[item.value.region]}}"
#    key_name: "{{aws_key_pair}}"
#    instance_type: "{{zchain.blueprint.instance_type[item.value.role]}}"
#    image: "{{instance_images[item.value.region]['ami_id']}}"
#    wait: yes
#    termination_protection: no
#    group:
#    instance_tags:
#      Name: "{{item.key}}"
#      role: "{{item.value.role}}"
#      network: "{{zchain.blueprint.network_type}}"
#    state: running
#    count_tag:
#      Name: "{{item.key}}"
#      role: "{{item.value.role}}"
#      network: "{{zchain.blueprint.network_type}}"
#  register: ec2
#  with_items: "{{agents}}"
#  check_mode: no
#
#- name: "Launch the server instances..."
#  ec2:
#    region: "{{regions[item.value.region]}}"
#    key_name: "{{aws_key_pair}}"
#    instance_type: "{{zchain.blueprint.instance_type[item.value.role]}}"
#    image: "{{instance_images[item.value.region]['ami_id']}}"
#    wait: no
#    termination_protection: no
#    group:
#    instance_tags:
#      Name: "{{item.key}}"
#      role: "{{item.value.role}}"
#      network: "{{zchain.blueprint.network_type}}"
#    exact_count: 1
#    count_tag:
#      Name: "{{item.key}}"
#      role: "{{item.value.role}}"
#      network: "{{zchain.blueprint.network_type}}"
#  register: ec2
#  with_items: "{{agents}}"
#  check_mode: no
#
#- set_fact:
#    nodes: "{{ec2 | json_query('results[*].tagged_instances')}}"

#- debug: var=nodes


- name: "Nodefile storage"
  debug:
    msg: "Node files storage: {{nodefiles}}"

- name: Clean the old nodefile directory
  file:
    state: absent
    path: "{{nodefiles.dir.local}}"


- debug:
    msg: "Show iprole {{iprole}}"

- name: "Show name and public ip mapping...nodes={{nodefiles.dir.local}}/{{nodefiles.file}}"
  lineinfile:
    path: "{{nodefiles.dir.local}}/{{nodefiles.file}}"
    create: yes
    line: "{{item.tags.Name[0]}},{{item.public_ip_address}},{{zchain.blueprint.ports[item.tags.role]}},{{clientid[item.tags.Name].client}},{{clientid[item.tags.Name].public}}"
  with_items: "{{nodes}}"

- name: "Update Route53 database"
  route53:
    state: present
    zone: testnet-0chain.net
    record: "{{item.tags.Name}}.testnet-0chain.net"
    value: "{{item.public_ip_address}}"
    type: A
    wait: no
    ttl: 60
  with_items: "{{nodes}}"


- name: "Creating the node mapping file..."
  debug:
    msg: "agent={{item}}"
  with_items: "{{agents}}"

- name: "Delete old node key file..."
  file:
    path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
    state: absent
  with_items: "{{agents}}"

- name: "Create the new node file...first add public key"
  lineinfile:
      path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
      create: yes
      line: "{{clientid[item.key].public}}"
  with_items: "{{agents}}"

- name: "Create the new node file...first add public key"
  lineinfile:
      path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
      create: yes
      line: "{{clientid[item.key].private}}"
  with_items: "{{agents}}"

- name: "Create the new node file...first add public key"
  lineinfile:
      path: "{{nodefiles.dir.local}}/{{item.key}}.txt"
      create: yes
      line: ""
  with_items: "{{agents}}"

...