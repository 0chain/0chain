---
- name: "Create the directory to store keys...{{aws_key_dir}}"
  file:
    path: "{{aws_key_dir}}"
    mode: 0755
    state: directory

- name: "Create key={{aws_key_pair}} in region={{primary_region}}"
  ec2_key:
    name: "{{aws_key_pair}}"
    region: "{{primary_region}}"
  register: keypair

- debug: msg="key={{aws_key_pair}} contents={{keypair}}"

- name: "Save key={{aws_key_pair}} to file={{aws_key_pair_file}}"
  copy:
    dest: "{{aws_key_pair_file}}"
    content: "{{ keypair.key.private_key }}"
    mode: 0400
  when: keypair.changed

- name: "Generate the public key"
  command: ssh-keygen -y -f "{{aws_key_pair_file}}" -t rsa -q
  register: publickey

- debug: var=publickey

- name: "Save public key {{publickey}} to  {{aws_public_key_file}}"
  copy:
    dest: "{{aws_public_key_file}}"
    content: "{{ publickey.stdout}}"
    mode: 0400

- name: "Add key={{aws_key_pair}} to regions={{region_tags}}"
  ec2_key:
    name: "{{aws_key_pair}}"
    region: "{{ item.value }}"
    key_material: "{{publickey.stdout}}"
    state: present
  with_dict: "{{ regions }}"
...
