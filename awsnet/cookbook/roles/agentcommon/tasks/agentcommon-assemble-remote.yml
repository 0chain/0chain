---
- name: "Collect facts on up agents"
  delegate_to: localhost
  ec2_instance_facts:
    region: "{{regions[item]}}"
    filters:
      "tag:network_name": "{{zchain.blueprint.network_name}}"
      "instance-state-name": running
  register: ec2_facts
  with_items: "{{zchain.blueprint.regions}}"

- set_fact:
   nodes: "{{ec2_facts | json_query('results[*].instances')}}"

- debug:
   msg: "{{nodes}}"

- set_fact:
   iprole: "{{ iprole | default({}) | combine( {item.public_ip_address: item.tags.Name})}}"
  with_items: "{{nodes}}"

- name: get public IP address
  ipify_facts:
  register: ipify_results

- set_fact:
    agent_ip: "{{ipify_results.ansible_facts.ipify_public_ip}}"

- set_fact:
    agent_tag: "{{iprole[agent_ip]}}"


- set_fact:
    agent_role: "{{ agents|selectattr('key', 'equalto', agent_tag ) | map(attribute='value.role') | list | first }}"

- debug:
    msg: "{{agent_role}}=={{agent_tag}}=={{agent_ip}}"
...