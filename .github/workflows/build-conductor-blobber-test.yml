name: CONDUCTOR_BLOBBER_TEST

on:
  workflow_dispatch:
    inputs:
      view_change: 
        description: 'Type true/false for setting view change.'
        default: 'false'
        required: true

jobs:
  conductor_build: 
    name: CONDUCTOR-BLOBBERS-TESTS
    runs-on: [self-hosted, conductor-test02]
    
    steps:
    - name: Go 1.16.5 setup.
      uses: actions/setup-go@v2
      with:
        go-version: '1.16.5'

    - name: Get Branch
      id: get_branch
      run: |
        BRANCH=$(echo ${GITHUB_REF#refs/heads/})
        echo ::set-output name=BRANCH::${BRANCH}

    - name: Git clone 0chain
      run: |
        git clone https://github.com/0chain/0chain.git
        git checkout ${{ steps.get_branch.outputs.BRANCH }}
    
    - name: Git clone blobber
      run: |
        git clone https://github.com/0chain/blobber.git

    - name: Git clone zboxcli
      run: |    
        git clone https://github.com/0chain/zboxcli.git
    
    - name: Git clone zwalletcli
      run: |
        git clone https://github.com/0chain/zwalletcli.git
    
    - name: Git clone 0dns
      run: |
        git clone https://github.com/0chain/0dns.git

    - name: list pwd
      run: |
        ls -lha
        cd 0chain && git status
        cd ../0dns && git status
        pwd

    - name: Install zboxcli
      run: |
        cd zboxcli && make install

    - name: Install zwalletcli
      run: |
        cd zwalletcli && make install
    
    - name: 0dns Patching
      run: |
        cd 0dns && git apply --check ../0chain/docker.local/bin/conductor/0dns-local.patch || true
        cd ../0dns && git apply ../0chain/docker.local/bin/conductor/0dns-local.patch || true
    
    - name: Blobbers Patching
      run: |
        cd blobber && git apply --check ../0chain/docker.local/bin/conductor/blobber-tests.patch || true
        cd ../blobber && git apply ../0chain/docker.local/bin/conductor/blobber-tests.patch || true
    
    - name: Add ZCN config
      run: |
        rm -rf ~/.zcn || true
        mkdir ~/.zcn
        cat <<\EOF > ~/.zcn/config.yaml
        block_worker: http://127.0.0.1:9091
        signature_scheme: bls0chain
        min_submit: 50
        min_confirmation: 50
        confirmation_chain_length: 3
        max_txn_query: 5
        query_sleep_time: 5
        EOF

    - name: List pwd zcn
      run: |
        pwd
        ls -lha ./
        ls -lha ~/.zcn
        cat ~/.zcn/config.yaml

    - name: Starting blobber Tests.
      run: |
        cd 0chain && ./docker.local/bin/start.conductor.sh blobber-1
        cd ../0chain && ./docker.local/bin/start.conductor.sh blobber-2
    
    - name: Clean up job.
      if: ${{ always() }}
      run: |
        rm -rf ./*
