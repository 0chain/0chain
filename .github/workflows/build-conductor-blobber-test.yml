name: CONDUCTOR_BLOBBER_TEST

on:
  workflow_dispatch:
    inputs:
      view_change: 
        description: 'Type true/false for setting view change.'
        default: 'false'
        required: true

env:
  ZCHAIN_BUILDBASE: zchain_build_base
  ZCHAIN_BUILDRUN: zchain_run_base

jobs:
  conductor_build: 
    name: CONDUCTOR-BLOBBERS-TESTS
    runs-on: [self-hosted, conductor-test02]
    
    steps:
    - name: Git clone 0chain
      run: |
        git clone https://github.com/0chain/0chain.git
        git clone https://github.com/0chain/blobber.git
        git clone https://github.com/0chain/zboxcli.git
        git clone https://github.com/0chain/zwalletcli.git
        git clone https://github.com/0chain/0dns.git

    - name: list pwd
      run: |
        ls -lha

    - name: Install zboxcli
      run: |
        cd zboxcli && make install
        cd ../zwalletcli && make install
        cd ../0dns && git apply --check ../0chain/docker.local/bin/conductor/0dns-local.patch
        cd ../0dns && git apply ../0chain/docker.local/bin/conductor/0dns-local.patch
        cd ../blobber && git apply --check ../0chain/docker.local/bin/conductor/blobber-tests.patch
        cd ../blobber && git apply ../0chain/docker.local/bin/conductor/blobber-tests.patch
        cd ../
    
    - name: Add ZCN config
      run: |
        cat <<\EOF > ./.zcn/config.yaml
          block_worker: http://127.0.0.1:9091
          signature_scheme: bls0chain
          min_submit: 50
          min_confirmation: 50
          confirmation_chain_length: 3
          max_txn_query: 5
          query_sleep_time: 5
        EOF

    - name: List pwd zcn
      run: |
        ls -lha .zcn

    - name: Starting blobber Tests.
      run: |
        cd 0chain && ./docker.local/bin/start.conductor.sh blobber-1
        cd ../0chain && ./docker.local/bin/start.conductor.sh blobber-2
        cd ../
    
    - name: Clean up job.
      run: |
        rm -rf ./*
    
    # # - name: Get Branch
    # #   id: get_info
    # #   run: |
    # #     BRANCH_TAG=$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//-/g')
    # #     BRANCH=$(echo ${GITHUB_REF#refs/heads/})
    # #     SHORT_SHA=$(echo $GITHUB_SHA | head -c 8)
    # #     echo ::set-output name=BRANCH::${BRANCH}
    # #     echo ::set-output name=IMAGE_TAG::${BRANCH_TAG}-${SHORT_SHA}
    # #     echo "Branch == ${BRANCH}"

    # # - name: Git Checkout
    # #   run: |
    # #     cd /root/0chain/
    # #     git checkout .
    # #     git pull
    # #     git checkout $BRANCH
    # #     git checkout rrrooommmaaa/conductor-peter
    # #   env:
    # #     BRANCH: ${{ steps.get_info.outputs.BRANCH }}

    # - name: Setting Up View Change
    #   run: |
    #     cd ./docker.local/config
    #     filename='0chain.yaml'
    #     # Check the new text is empty or not
    #     if ! grep -q view_change "$filename"; then
    #       sed -i "12 a \  view_change: $VIEW_CHANGE" $filename
    #     else
    #       sed -i '/view_change/d' $filename
    #       sed -i "12 a \  view_change: $VIEW_CHANGE" $filename
    #     fi
    #   env:
    #     VIEW_CHANGE: ${{ github.event.inputs.view_change }}

    # - name: Building Base Images
    #   run: |
    #     docker build -f ./docker.local/build.base/Dockerfile.build_base . -t $ZCHAIN_BUILDBASE
    #     docker build -f ./docker.local/build.base/Dockerfile.run_base docker.local/build.base -t $ZCHAIN_BUILDRUN

    # - name: Installing ZBOXCLI.
    #   run: |
    #     cd /root/zboxcli/
    #     git checkout .
    #     git pull
    #     git checkout master
    #     source ~/.profile
    #     make install

    # - name: Installing ZWALLETCLI.
    #   run: |
    #     cd /root/zwalletcli/
    #     git checkout .
    #     git pull
    #     git checkout master
    #     source ~/.profile
    #     make install

    # - name: Patching 0DNS
    #   run: |
    #     cd /root/0dns/
    #     git checkout .
    #     git pull
    #     git checkout master
    #     git apply --check ../0chain/docker.local/bin/conductor/0dns-local.patch
    #     git apply ../0chain/docker.local/bin/conductor/0dns-local.patch

    # - name: Patching BLOBBERS
    #   run: |
    #     cd /root/blobber/
    #     git checkout .
    #     git pull
    #     git checkout master
    #     git apply --check ../0chain/docker.local/bin/conductor/blobber-tests.patch
    #     git apply ../0chain/docker.local/bin/conductor/blobber-tests.patch

    # - name: Running Blobber tests.
    #   run: |
    #     cd /root/0chain/
    #     git apply --check ../0chain/docker.local/bin/conductor/blobber-tests.patch
    #     git apply ../0chain/docker.local/bin/conductor/blobber-tests.patch
