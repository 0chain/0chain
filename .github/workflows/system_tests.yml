name: "0Chain System Tests"

concurrency:
  group: "${{ github.ref }}"
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
       system_tests_branch:
        description: 'system_tests branch. Containing the tests you wish to run'
        default: 'master'
        required: true
       zbox_cli_branch:
        description: '0Box CLI (branch or commit SHA) which the tests will use'
        default: 'staging'
        required: true
       zwallet_cli_branch:
        description: '0Wallet CLI (branch or commit SHA) which the tests will use'
        default: 'staging'
        required: true
       blobber_image:
        description: 'blobber DOCKER IMAGE to deploy'
        default: 'staging'
        required: true
       validator_image:
        description: 'validator DOCKER IMAGE to deploy'
        default: 'staging'
        required: true
       zbox_image:
        description: '0box DOCKER IMAGE to deploy'
        default: 'staging'
        required: true
       zblock_image:
        description: '0block DOCKER IMAGE to deploy'
        default: 'staging'
        required: true
       skip_tests:
        description: '(LAST RESORT ONLY) Skip system tests. This will allow a PR to merge without requiring a green test run.  *By using you certify that the code being merged is not causing system tests to fail*'
        default: 'FALSE'
        required: true
jobs:
  system-tests:
    runs-on: [ tests-suite ]
    steps:

    - uses: actions/checkout@v2

    - name: "Setup Test Run"
      run: |
        echo "SHORT_SHA=$(echo $GITHUB_SHA | head -c 8)" >> $GITHUB_ENV
        echo "TAG=$(echo ${GITHUB_REF##*/} | sed 's/\//-/g')" >> $GITHUB_ENV
        echo "NETWORK_URL=$(echo dev-${RUNNER_NAME:(-1)}.devnet-0chain.net)" >> $GITHUB_ENV
        echo "RUNNER_NUMBER=${RUNNER_NAME:(-1)}" >> $GITHUB_ENV

    - name: "Set PR Status Pending"
      uses: 0chain/actions/notify-pull-request@feature/notify-PR-convenience
      with:
        state: "pending"
        system_tests_branch: ${{ github.event.inputs.system_tests_branch }}

    - name: "Sleep"
      run: sleep 60

    - name: "Set PR Status Success"
      if: ${{ success() }}
      uses: 0chain/actions/notify-pull-request@feature/notify-PR-convenience
      with:
        state: ${{ job.status }}
        system_tests_branch: ${{ github.event.inputs.system_tests_branch }}
        token: ${{ github.token }}

    - name: "Set PR Status Failed"
      if: ${{ failure() }}
      uses: 0chain/actions/notify-pull-request@feature/notify-PR-convenience
      with:
        state: ${{ job.status }}
        system_tests_branch: ${{ github.event.inputs.system_tests_branch }}
        token: ${{ secrets.SVC_ACCOUNT_SECRET }}

