--- 
networks: 
  default: 
    driver: bridge
services: 
  cassandra-init: 
    command: "bash /0chain/bin/scylla-init.sh"
    image: "cassandra:latest"
    links: 
      - "scylla:scylla"
    restart: on-failure
    user: "2000:2000"
    volumes: 
      - "../../bin:/0chain/bin"
      - "../../sql:/0chain/sql"
  scylla: 
    healthcheck: 
      interval: 30s
      retries: 5
      test: 
        - CMD-SHELL
        - "[ $$(nodetool statusgossip) = running ]"
      timeout: 10s
    image: "scylladb/scylla:2.3.0"
    networks: 
      - default
    ports: 
      - "9042:9042"
    user: "2000:2000"
    volumes: 
      - "/0chain/config/scylla/scylla.yaml:/etc/scylla/scylla.yaml"
      - "/0chain/config/scylla:/0chain/scylla"
      - "/0chain/data/scylla:/var/lib/scylla"
      - "/0chain/0chain/sql:/0chain/sql"
      - "/0chain/config/scylla/scylla-server:/etc/sysconfig/scylla-server"
  sharder: 
    build: 
      context: /0chain/0chain
      dockerfile: /0chain/0chain/docker.aws/build.sharder/Dockerfile
    command: "./bin/sharder --deployment_mode 0 --keys_file /0chain/config/${SHARDER}.txt --nodes_file nodes"
    depends_on: 
      - cassandra-init
    environment: 
      - DOCKER=true
      - CASSANDRA_CLUSTER=scylla
    links: 
      - "cassandra-init:cassandra-init"
    logging: 
      driver: json-file
      options: 
        max-file: "10"
        max-size: 10M
    networks: 
      default: ~
    pid: host
    ports: 
      - "7171:7171"
    ulimits: 
      nofile: 
        hard: 32768
        soft: 32768
    user: "2000:2000"
    volumes: 
      - "/0chain/config:/0chain/config"
      - "/0chain/nodes:/0chain/nodes"
      - "/0chain/log:/0chain/log"
      - "/0chain/data/blocks:/0chain/data/blocks"
      - "/0chain/data:/0chain/data"
version: "3"
volumes: 
  config: ~
  data: ~
  nodes: ~
