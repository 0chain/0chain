---
- hosts: localhost

  connection: local

  gather_facts: no

  vars_files:
    - aws_vars.yml

  environment:
    AWS_SHARED_CREDENTIALS_FILE: "{{ aws_credentials }}"
    AWS_PROFILE: "testnet"

  tasks:
    - debug: var=aws_credentials
    - name: remove key pair
      ec2_key:
        region: "{{ region }}"
        name: "{{key_pair}}"
        state: absent

    - name: create key pair
      ec2_key:
        name: "{{key_pair}}"
        region: "{{region}}"
      register: keypair

    - name: write the key to a file
      copy:
        dest: "{{key_pair_file}}"
        content: "{{ keypair.key.private_key }}"
        mode: 0600
      when: keypair.changed

    - name: dump var
      debug: var=keypair
...

